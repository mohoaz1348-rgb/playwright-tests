name: UI tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  run-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install Python and Dependencies
        run: |
          uv python install         
          uv sync --frozen          # Ставим библиотеки строго по лок-файлу
          uv run playwright install chromium --with-deps

      - name: Run UI tests with pytest and generate Allure results
        run: |
          uv run pytest -m debug

      - name: Upload Allure results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: results/allure-results
          retention-days: 1

  publish-report:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: always()
    needs: [ run-tests ]

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Download Allure results
        uses: actions/download-artifact@v4
        with:
          name: allure-results
          path: allure-results

      - name: Install Allure CLI
        run: |
          wget https://github.com/allure-framework/allure2/releases/download/2.36.0/allure-2.36.0.tgz
          tar -zxf allure-2.36.0.tgz
          sudo mv allure-2.36.0 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/bin/allure
          allure --version
      
      - name: Generate Report
        run: |
          # 1. Определяем номера запусков
          CURRENT_RUN=${{ github.run_number }}
          PREVIOUS_RUN=$((CURRENT_RUN - 1))
          
          # 2. Подготавливаем папку для истории в новых результатах
          mkdir -p allure-results/history
          
          # 3. Копируем историю из ПРЕДЫДУЩЕЙ папки (если она есть в gh-pages)
          if [ -d "gh-pages/$PREVIOUS_RUN/history" ]; then
            cp -r gh-pages/$PREVIOUS_RUN/history/* allure-results/history/
            echo "History from run $PREVIOUS_RUN copied."
          fi
          # ДОБАВЛЯЕМ executor.json (Чтобы на графике появились номера билдов)
          echo '{
            "name": "GitHub Actions",
            "type": "github",
            "reportName": "UI Tests Report",
            "url": "https://github.com/${{ github.repository }}",
            "buildOrder": '${CURRENT_RUN}',
            "buildName": "#'${CURRENT_RUN}'",
            "buildUrl": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            "reportUrl": "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${CURRENT_RUN}/"
          }' > allure-results/executor.json
          
          # Чистим старье (оставляем 20 папок)
          ls -d gh-pages/*/ 2>/dev/null | grep -E '/[0-9]+/$' | sort -V | head -n -20 | xargs rm -rf || true

          # 4. Генерируем новый отчет в папку с номером текущего запуска
          # Мы создаем папку внутри gh-pages, чтобы деплой отправил всё разом
          allure generate allure-results --clean -o gh-pages/$CURRENT_RUN
          
          # 5. Создаем или обновляем корневой index.html для редиректа на последний отчет
          #echo "<!DOCTYPE html><html><head><meta http-equiv='refresh' content='0; url=$CURRENT_RUN/'></head><body>Redirecting to latest report...</body></html>" > gh-pages/index.html
          echo "<!DOCTYPE html><meta charset="utf-8"><meta http-equiv="refresh" content='0; URL=$CURRENT_RUN/'><meta http-equiv="Pragma" content="no-cache"><meta http-equiv="Expires" content="0">" > gh-pages/index.html

      - name: Deploy report to Github Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: gh-pages  # Пушим всю папку, включая все прошлые отчеты и новый index.html


